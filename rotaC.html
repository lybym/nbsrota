<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>rotaC</title>
<link rel="stylesheet" href="css/jquery-ui.min.css">
<link rel="stylesheet" href="css/rotaC.css?v=1">
<script src="libs/jquery/3.3.1/jquery.min.js"></script>
<script src="libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="libs/jqueryui/datepicker-zh-CN.js"></script>
<script src="libs/funclibs.js?v=1"></script>
<style>


</style>

<script>

</script>
</head>

<body>
    <p>请选择需要查询的日期：<input type="text" id="datepicker"></p>
    <div id="rota_record_title">

    </div>
    <div id="rota_record">
        
    </div>
    <button id="btn1">提交修改</button>

<script>
$("#datepicker").datepicker({
    changeMonth: true,
    changeYear: true,
    minDate: new Date(2014,12-1,29), //起始从2015年1月1日开始
    maxDate: "+2Y" //多显示之后2年
});

$("#datepicker").change(function(){
    var dpget = $("#datepicker").val();
    $("#rota_record").empty();
    sdateid=dateidCreate(wStartDate(dpget));edateid=dateidCreate(wEndDate(dpget));
    //console.log(sdateid);console.log(edateid);
    //var sdateid=1178;var edateid=1184;
    for(weeknum=sdateid;weeknum<=edateid;weeknum++){
        $("#rota_record").append('<ul class="rota-record" id="rota_record_' + weeknum + '"></ul>');
        $('#rota_record_' + weeknum).append('<li class="rota-record-date" id="date_' + weeknum + '"></li>');
        $('#rota_record_' + weeknum).append('<li class="rota-record-week" id="week_' + weeknum + '"></li>');
        $('#rota_record_' + weeknum).append('<li class="rota-record-time" id="time_' + weeknum + '"></li>');
        $('#time_' + weeknum).append('<div class="rota-record-time-cont" id="time_cont_' + weeknum + '">夜班</div>');
        $('#time_' + weeknum).append('<div class="rota-record-time-cont" id="time_cont_' + weeknum + '">早班</div>');
        $('#time_' + weeknum).append('<div class="rota-record-time-cont" id="time_cont_' + weeknum + '">中班</div>');
        $('#time_' + weeknum).append('<div class="rota-record-time-cont" id="time_cont_' + weeknum + '">晚班</div>');
        $('#rota_record_' + weeknum).append('<li class="rota-record-duty" id="duty_' + weeknum + '"></li>');
        for(row=1;row<=4;row++){
            $('#duty_' + weeknum).append('<ul class="rota-record-duty-row" id="cont_' + weeknum + '_' + row + '"></ul>');
            for(col=1;col<=5;col++){
                if (col==2){//历史遗留原因需要跳过2
                    continue;
                }
                $('#cont_' + weeknum +'_' + row).append('<input class="rota-record-duty-col" id="cont_' + weeknum + '_' + row + col + '">');
            }
        }
        $('#rota_record_' + weeknum).append('<li class="rota-record-others" id="other_' + weeknum + '">others</li>');
    }

    var allrotainfo;
    var dayinfo;
    var nameinfo;
    var dutyinfo;
    var rotainfo;
    $.getJSON('getrotainfo.php', {'sdateid': sdateid, 'edateid': edateid}, function(data) {
        allrotainfo=data;
        dayinfo=allrotainfo.dayinfo;
        nameinfo=allrotainfo.nameinfo;
        dutyinfo=allrotainfo.dutyinfo;
        rotainfo=allrotainfo.rotainfo;
        console.log(allrotainfo);
        for(dateid=sdateid;dateid<=edateid;dateid++){
            var week=dayinfo[dateid].week;
            $('#date_' + dateid).append(dayinfo[dateid].month+'月'+dayinfo[dateid].day+'日');
            $('#week_' + dateid).append('星期'+weekdayZH[week]);
            if(isHoilday(dateid,dayinfo)){
                $('#date_' + dateid).addClass("hoilday");
                $('#week_' + dateid).addClass("hoilday");
            }
            Object.keys(nameinfo).forEach(function(nameid){//
                var rotadisnum=rotainfo[nameid][dateid];
                Object.keys(rotadisnum).forEach(function(rotacontnum){
                    if(rotadisnum[rotacontnum]!='0'){
                        $('#cont_' + dateid + '_' + rotadisnum[rotacontnum]).val(nameidToReming(nameid,nameinfo));
                    }
                });
                
            });
        }
    
        var name_source=[];//["人名",...]数组
        //var name_renming=[];//[name_x:"人名",...]数组
        var renming_namex=[];//["人名":name_x,...]数组,用来供构建update json查询
        Object.keys(nameinfo).forEach(function(nameid){//
            var name=nameinfo[nameid].renming;
            //var name_x=nameinfo[nameid].name_x;
            //name_renming[name_x]=name;
            renming_namex[name]=nameinfo[nameid].name_x;
            name_source.push(name);
        });
        //console.log(renming_namex);
        //console.log(name_source);

        $(".rota-record-duty-col").autocomplete({
            minLength: 0,
            source: name_source
        });
        
        $("#btn1").click(function(){
            var updateinfo={};
            updateinfo.rotainfo={};
            updateinfo.otherinfo={};
            for(update_nameX=2;update_nameX<=25;update_nameX++){//没解决依次读入nameid作为循环
                updateinfo.rotainfo[update_nameX]={};
                for(update_dateid=sdateid;update_dateid<=edateid;update_dateid++){
                    updateinfo.rotainfo[update_nameX][update_dateid]=[];
                }
            }
            $(".rota-record-duty-col").each(function(){
                var updatedateid=$(this).attr("id").substr(5,4);
                var updateduty=$(this).attr("id").substr(10,2);
                var updatename=$(this).val();
                var updatename_x=renming_namex[updatename];
                if(updatename!=''){
                    updateinfo.rotainfo[updatename_x][updatedateid][0]=updateduty;//没解决多个数据push进入
                }
            });
            console.log(updateinfo);
        });
    });
});



</script>
</body>
</html>